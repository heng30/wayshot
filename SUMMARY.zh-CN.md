# Wayshot 项目总结

## 概述

Wayshot 是一个专为 Linux Wayland 系统设计的综合屏幕录制解决方案，使用 wlroots 扩展协议。完全基于 Rust 和 Slint GUI 框架构建，提供跨平台屏幕录制功能，包括音频录制、光标跟踪和降噪等高级特性。

## 项目架构

### 工作空间结构

项目采用模块化设计的 Cargo 工作空间架构：

- **wayshot/** - 带 Slint 界面的主 GUI 应用程序
- **lib/recorder/** - 核心屏幕录制引擎
- **lib/screen-capture/** - 抽象屏幕捕获接口
- **lib/screen-capture-wayland-wlr/** - Wayland 特定实现
- **lib/mp4m/** - MP4 处理和复用
- **lib/cutil/** - 通用工具库
- **lib/sqldb/** - SQL 数据库抽象
- **lib/pmacro/** - Slint 集成的过程宏
- **tr-helper/** - 翻译管理工具
- **icon-helper/** - 图标生成工具

### 核心技术

- **Rust 2024 版本** - 具有高级特性的现代 Rust
- **Slint GUI 框架** - 原生跨平台 UI
- **Wayland wlroots 协议** - Linux 屏幕捕获
- **x264 编码** - 硬件加速视频压缩
- **PipeWire** - Linux 音频系统集成
- **Crossbeam** - 高性能并发数据结构
- **Rayon** - 图像处理的数据并行

## 核心组件

### 1. 屏幕捕获系统

**抽象层 (`screen-capture`)**
- 平台无关的屏幕捕获接口
- 支持多显示器配置
- 高精度光标位置跟踪
- 可配置的帧率和捕获区域

**Wayland 实现 (`screen-capture-wayland-wlr`)**
- 直接的 wlroots 协议集成
- 零拷贝优化的实时屏幕捕获
- 硬件加速缓冲区管理
- 支持 Sway、Hyprland 和其他 wlroots 合成器

### 2. 录制引擎 (`recorder`)

**视频处理**
- 多线程视频捕获和编码管道
- 支持多种分辨率：原始、720p、480p、360p
- 帧率选项：24、25、30、60 FPS
- 使用 rayon 并行化的实时图像调整大小
- YUV 色彩空间转换和优化

**音频系统**
- 多源音频录制（麦克风 + 桌面音频）
- 基于 CPAL 的跨平台音频输入
- Linux 系统音频的 PipeWire 集成
- 带视觉反馈的实时音频电平监控
- 单声道转换和降噪（NNNoiseless 算法）

**高级功能**
- 像素级精度的光标跟踪
- 可配置的录制质量和比特率
- 实时性能监控
- 自动设备检测和配置

### 3. MP4 处理 (`mp4m`)

**视频编码**
- 可定制质量配置文件的 x264 编码
- 不同质量/压缩比的 H.264/H.265 支持
- 标准的 90kHz 视频时间刻度以获得最大兼容性
- 实时帧处理和缓冲

**音频处理**
- 使用 FDK-AAC 的高质量音频 AAC 编码
- 多轨音频支持（用户输入 + 系统音频）
- 自动音频同步和混合
- 支持各种采样率和位深度

**复用**
- MP4 容器创建和管理
- 流同步和时间戳对齐
- 元数据嵌入和章节支持
- 直播场景的渐进式输出

### 4. GUI 应用程序 (`wayshot`)

**跨平台界面**
- 具有 Material/Fluent 设计的原生 Slint 组件
- 适应桌面、移动端和 Web 的响应式布局
- 实时录制控制和监控
- 全面的设置和首选项

**平台支持**
- **桌面端**：Linux (Wayland)、Windows、macOS
- **移动端**：具有原生集成的 Android
- **Web**：浏览器使用的 WebAssembly 编译

**用户体验**
- 带视觉反馈的直观录制工作流程
- 实时音频电平指示器
- 屏幕选择和区域配置
- 导出选项和格式自定义

### 5. 工具库

**通用工具 (`cutil`)**
- 具有安全抽象的文件系统操作
- 字符串操作和格式化工具
- 带时区支持的时间处理
- 带 TLS 支持的 HTTP 客户端工具
- 加密函数（AES、CBC、哈希）

**数据库层 (`sqldb`)**
- 具有类型安全的 SQL 数据库抽象
- 连接池和事务管理
- 查询构建和结果映射
- 迁移系统支持

**过程宏 (`pmacro`)**
- 自动 Slint UI 类型转换
- 双向 Rust-Slint 结构映射
- UI 模型的向量字段处理
- 编译时代码生成

## 开发工作流程

### 构建系统

**Makefile 集成**
- 平台特定构建目标（桌面、Android、Web）
- 调试和发布配置
- 自动化测试和质量检查
- 分发包生成

**Nix 支持**
- 可重现的开发环境
- 使用覆盖层的依赖管理
- 交叉编译工具链
- 包含所有依赖的开发 Shell

### 测试基础设施

**全面测试套件**
- 所有核心组件的单元测试
- 真实硬件的集成测试
- 性能基准测试和回归测试
- 每个功能的示例演示

**示例应用程序**
- 基本录制演示（5秒、10分钟录制）
- 仅音频录制测试
- 光标跟踪演示
- 降噪评估
- 设备枚举测试

### 质量保证

**代码质量**
- 严格规则的 Clippy 检查
- Rustfmt 代码格式化
- 自动依赖更新
- 安全漏洞扫描

**性能优化**
- 配置文件引导优化
- 内存使用监控
- CPU 利用率基准测试
- 实时性能指标

## 平台特定功能

### Linux Wayland
- 原生 wlroots 协议支持
- PipeWire 音频集成
- 多显示器工作空间处理
- XDG 桌面集成

### Android
- 原生 Android 活动生命周期
- 触摸优化界面
- 权限管理
- 存储访问框架

### WebAssembly
- 基于浏览器的屏幕捕获
- WebRTC 音频集成
- 渐进式 Web 应用支持
- 离线功能

## 高级功能

### 实时处理
- 零拷贝缓冲区管理
- 硬件加速编码
- 并行音频/视频处理
- 低延迟捕获管道

### 音频增强
- 专业降噪
- 自动增益控制
- 多声道音频混合
- 实时音频分析

### 用户体验
- 录制期间实时预览
- 暂停/恢复功能
- 自动错误恢复
- 多格式导出

## 技术规格

### 支持格式
- **视频**：H.264、H.265、MP4 容器
- **音频**：AAC、PCM、WAV、FLAC
- **分辨率**：原始、1920x1080、1280x720、854x480、640x360
- **帧率**：24、25、30、60 FPS

### 系统要求
- **Linux**：支持 wlroots 的 Wayland 合成器
- **音频**：PipeWire 或 PulseAudio
- **依赖**：libpipewire、libalsa
- **硬件**：最低 CPU 要求，GPU 加速可选

### 性能指标
- **CPU 使用率**：1080p30 录制期间 5-15%
- **内存**：典型录制 100-200MB
- **延迟**：捕获到编码 <100ms
- **质量**：可变比特率高达 10Mbps

## 开发理念

Wayshot 项目强调：
- **模块化**：具有明确定义接口的关注点清晰分离
- **性能**：针对实时屏幕录制优化，最小开销
- **跨平台**：不同平台间最大代码复用
- **用户体验**：具有全面功能的直观界面
- **质量**：经过广泛测试的生产就绪代码
- **可维护性**：具有全面文档的清晰代码架构

这种架构使 Wayshot 成为一个强大、可扩展和高性能的屏幕录制解决方案，适合休闲用户和专业应用程序使用。
